<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
                
        <title>LARX 0.01</title>
        <link href="style.css" rel="stylesheet" />
        
        <!-- SHADERS -->
        <script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            void main(void) {
                gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
            }
        </script>
        
        <script id="shader-vs" type="x-shader/x-vertex">
        
            attribute vec3 aVertexPosition;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;

            void main(void) {
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
            }
        
        </script>
        
        <!-- DIST -->
        <script src="/js/dist/q.js"></script>
        <script src="/js/dist/gl-matrix.js"></script>
        
        <!-- SCRIPTS -->
        <script src="/js/viewport.js"></script>
        <script src="/js/gl/engine.js"></script>
        <script src="/js/gl/matrix.js"></script>
        <script src="/js/gl/shaders.js"></script>
        <script src="/js/gl/camera.js"></script>
        <script src="/js/gl/model.js"></script>
        
    </head>
    
    <body> 
        <canvas id="viewport"></canvas>
    </body>
    
    <!-- INITIALIZATION -->
    <script>
        
        var vp = new Viewport();
        var engine = new Engine(vp);
        var gl, shaders;
        var trees, water;
        
        trees = [];
        
        engine.init(function(deferred) {
            gl = engine.get();
            shaders = gl.shaders.get();
            
            return Q.all([
                gl.model.load('water').then(function(model) {
                    water = model;
                }),
                gl.model.load('tree').then(function(model) {
                    for(var i = 0; i < 100; i ++) {
                        var tree = gl.model.clone(model);
                        
                        tree.x = Math.random() * 20 - 10;
                        tree.z = Math.random() * 20 - 10;
                        gl.model.rotate(tree, Math.random() * Math.PI);
                        
                        trees.push(tree);
                    }
                })
            ]);
        });
        
        engine.render(function() {
            gl.matrix.setIdentity();
            gl.matrix.setUniforms(shaders.default);
                       
            gl.model.render(water, shaders.default);
            
            
            for(var i = 0; i < trees.length; i ++) {
                gl.matrix.setIdentity()
                gl.matrix.translate([trees[i].x, 0, trees[i].z]);
                gl.matrix.setUniforms(shaders.default);
                
                gl.model.render(trees[i], shaders.default);
            }
            
            keyboard();
            mouse();
        });
        
        function keyboard() {
            if(vp.keyDown('W')) { gl.camera.move( 0.0,  0.5); }
            if(vp.keyDown('S')) { gl.camera.move( 0.0, -0.5); }
            if(vp.keyDown('A')) { gl.camera.move(-0.5,  0.0); }
            if(vp.keyDown('D')) { gl.camera.move( 0.5,  0.0); }
        }
        
        function mouse() {
            if(vp.mouse.buttons.right) {
                gl.camera.rotate(vp.mouse.deltaX / 3.0, vp.mouse.deltaY / 3.0);
            }
            
            if(vp.mouse.wheelDelta !== 0) {
                gl.camera.zoom(-vp.mouse.wheelDelta);
            }
            
            vp.resetDelta();
        }
            
    </script>
</html>