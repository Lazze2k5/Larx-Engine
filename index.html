<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1">
        
        <title>LARX 0.01</title>
        <link href="style.css" rel="stylesheet" />
                
        <!-- DIST -->
        <script src="/js/dist/q.js"></script>
        <script src="/js/dist/gl-matrix.js"></script>
        
        <!-- SCRIPTS -->
        <script src="/js/viewport.js"></script>
        
        <script src="/js/gl/engine.js"></script>
        <script src="/js/gl/matrix.js"></script>
        <script src="/js/gl/shaders.js"></script>
        <script src="/js/gl/camera.js"></script>
        <script src="/js/gl/model.js"></script>
        
        <script src="/js/terrain.js"></script>
        <script src="/js/water.js"></script>
    </head>
    
    <body> 
        <div id="viewport">
            <div id="fullscreen">Fullscreen</div>
            <canvas class="renderTarget"></canvas>
        </div>
    </body>
    
    <!-- INITIALIZATION -->
    <script>
        
        var vp = new Viewport();
        var engine = new Engine(vp);
        var terrain = new Terrain();
        
        var gl, shaders;
        var mTrees, mWater, mTerrain;
        
        mTrees = [];
        
        engine.init(function() {
            var deferred = Q.defer();
            gl = engine.get();
            shaders = gl.shaders.get();
            
            
            terrain.generatefromImage(gl, '/heightmaps/test-mid.jpg', 8, 1.5, 1)
                .then(function(t) {
                    mTerrain = t;
                    mTerrain.model.shininess = 1.0;
                    mTerrain.model.specularWeight = 0.15;  
                    return Q(true);
                })
                .then(function() {
                    var deferred = Q.defer();
                    
                    gl.model.load('water').then(function(model) {
                        mWater = model;
                        mWater.shininess = 3.0;
                        mWater.opacity = 0.6;
                        mWater.specularWeight = 1.0;
                        deferred.resolve(true);
                    });
                    return deferred.promise;
                })
                .then(function(model) {
                    var deferred = Q.defer();
                    
                    gl.model.load('tree').then(function(model) {
                        model.shininess = 1.0;
                        model.specularWeight = 1.0;
                        
                        while(mTrees.length < 3000) {
                            var tree = gl.model.clone(model);
                            
                            tree.x = Math.random() * 94 - 47;
                            tree.z = Math.random() * 94 - 47;
                            tree.y = terrain.getElevationAtPoint(mTerrain, tree.x, tree.z);
                            
                            if(tree.y >= 0.2) {
                                gl.model.rotate(tree, Math.random() * Math.PI);
                                mTrees.push(tree);
                            }
                        }
                        
                        deferred.resolve(true);
                    });
                    return deferred.promise;
                })
                .done(function() {
                    deferred.resolve(true);
                })
                
             return deferred.promise;
        });
        
        engine.render(function() {
            
            for(var i = 0; i < mTrees.length; i ++) {
                gl.matrix.setIdentity();
                gl.matrix.translate([mTrees[i].x, mTrees[i].y, mTrees[i].z]);
                gl.matrix.setUniforms(shaders.default);
                
                gl.model.render(mTrees[i], shaders.default);
            }
            
            gl.matrix.setIdentity();
            gl.matrix.setUniforms(shaders.default);
            gl.model.render(mTerrain.model, shaders.default);
            gl.model.render(mWater, shaders.default);
            
            keyboard();
            mouse();
        });
        
        function keyboard() {
            if(vp.keyDown('W')) { gl.camera.move( 0.0,  0.5); }
            if(vp.keyDown('S')) { gl.camera.move( 0.0, -0.5); }
            if(vp.keyDown('A')) { gl.camera.move(-0.5,  0.0); }
            if(vp.keyDown('D')) { gl.camera.move( 0.5,  0.0); }
        }
        
        function mouse() {
            if(vp.mouse.buttons.right || vp.mouse.touchDown) {               
                gl.camera.rotate(vp.mouse.deltaX / 3.0, vp.mouse.deltaY / 3.0);
            }
            
            if(vp.mouse.wheelDelta !== 0) {
                gl.camera.zoom(-vp.mouse.wheelDelta);
            }
            
            vp.resetDelta();
        }
        
        document.getElementById('fullscreen').onclick = function() {
            vp.toggleFullscreen();
        };
            
    </script>
</html>